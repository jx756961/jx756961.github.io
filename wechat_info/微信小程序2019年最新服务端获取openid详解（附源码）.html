<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>微信小程序2019年最新服务端获取openid详解（附源码）</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
<h2 style="text-align: center;">微信小程序2019年最新服务端获取openid详解</h2>
  <div class="stackedit__html"><h5><a id="_0"></a>服务器获取原因</h5>
<ol>
<li>因为微信不允许把官方域名放到合法请求域名中, 所以官方规定必须在服务端请求openid返回给你本地</li>
<li>把APPID和秘钥放在小程序本地不安全<br>
<img src="https://img-blog.csdnimg.cn/20190416162725937.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5MDQzOTIz,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
<li>请求链接</li>
</ol>
<pre><code class="prism language-shell">https://api.weixin.qq.com/sns/jscode2session?appid<span class="token operator">=</span>APPID<span class="token operator">&amp;</span>secret<span class="token operator">=</span>SECRET<span class="token operator">&amp;</span>js_code<span class="token operator">=</span>JSCODE<span class="token operator">&amp;</span>grant_type<span class="token operator">=</span>authorization_code
</code></pre>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/auth.code2Session.html">官方文档地址</a><br>
<img src="https://img-blog.csdnimg.cn/2019041708072167.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5MDQzOTIz,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h5><a id="_10"></a>实现</h5>
<ol>
<li>本地通过开放接口<code>wx.login()</code> 获取<code>code</code>码, 主要<code>参照官方实例</code>避免后期更新。</li>
</ol>
<pre><code class="prism language-javascript"> wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      success<span class="token punctuation">:</span> res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'code:'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
          <span class="token keyword">var</span> loginUrl <span class="token operator">=</span> <span class="token string">'getOpenidSever.php'</span> <span class="token comment">//服务端的接口地址</span>
          wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token punctuation">:</span> loginUrl<span class="token punctuation">,</span>
            method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
            dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
            data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              jscode<span class="token punctuation">:</span> res<span class="token punctuation">.</span>code <span class="token comment">//发送的code码</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>	
            success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'data:'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            fail<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            complete<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 发送 res.code 到后台换取 openId, sessionKey, unionId</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20190417085329759.png#pic_center" alt="在这里插入图片描述"></p>
<ol start="2">
<li>服务端实现</li>
</ol>
<p>getOpenidSever.php:</p>
<pre><code class="prism language-php"><span class="token comment">/**
 * 请求接口返回内容
 * @param  string $url [请求的URL地址]
 * @param  string $params [请求的参数]
 * @param  int $ipost [是否采用POST形式]
 * @return  string
 */</span>
<span class="token keyword">class</span> <span class="token class-name">getOpenid</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$url</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$jscode</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$params</span><span class="token punctuation">;</span>
    
	<span class="token comment">/**
	 * 配置URL请求参数
	 */</span>
    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$jscode</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">jscode</span> <span class="token operator">=</span> <span class="token variable">$jscode</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">url</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'https://api.weixin.qq.com/sns/jscode2session'</span><span class="token punctuation">;</span><span class="token comment">//请求地址</span>
        <span class="token variable">$paramsArray</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token single-quoted-string string">'appid'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'wxfddfkjs54g5r5d5sdsf'</span><span class="token punctuation">,</span><span class="token comment">//你的appid</span>
            <span class="token single-quoted-string string">'secret'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'krj9er9df883kjd4j5k435jk34fddf'</span><span class="token punctuation">,</span><span class="token comment">//你的秘钥</span>
            <span class="token single-quoted-string string">'js_code'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">jscode</span><span class="token punctuation">,</span><span class="token comment">//发送过来的code码</span>
            <span class="token single-quoted-string string">'grant_type'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'authorization_code'</span><span class="token comment">//授权类型参照官方文档 ： authorization_code</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span> <span class="token operator">=</span> <span class="token function">http_build_query</span><span class="token punctuation">(</span><span class="token variable">$paramsArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//生成URL参数字符串</span>

    <span class="token punctuation">}</span>
    
	<span class="token comment">/**
	 * 请求URL方法, 一些参数没必要理解知道就行
	 */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getCurl</span><span class="token punctuation">(</span><span class="token variable">$ispost</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$httpInfo</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//CURL_HTTP_VERSION_NONE (默认值，让 cURL 自己判断使用哪个版本)，CURL_HTTP_VERSION_1_0 (强制使用 HTTP/1.0)或CURL_HTTP_VERSION_1_1 (强制使用 HTTP/1.1)。</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HTTP_VERSION</span><span class="token punctuation">,</span> <span class="token constant">CURL_HTTP_VERSION_1_1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在HTTP请求中包含一个"User-Agent: "头的字符串。</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_USERAGENT</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.118 Safari/537.36'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在尝试连接时等待的秒数。设置为0，则无限等待。</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CONNECTTIMEOUT</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//允许 cURL 函数执行的最长秒数。</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_TIMEOUT</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TRUE 将curl_exec()获取的信息以字符串返回，而不是直接输出。</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ispost</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//TRUE 时会发送 POST 请求，类型为：application/x-www-form-urlencoded，是 HTML 表单提交时最常见的一种。</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POST</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//全部数据使用HTTP协议中的 "POST" 操作来发送</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POSTFIELDS</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//需要获取的 URL 地址，也可以在curl_init() 初始化会话的时候</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//需要获取的 URL 地址，也可以在curl_init() 初始化会话的时候。</span>
                <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">url</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'?'</span> <span class="token punctuation">.</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$response</span> <span class="token operator">===</span> <span class="token constant">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//echo "cURL Error: " . curl_error($ch);</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$httpCode</span> <span class="token operator">=</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLINFO_HTTP_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$httpInfo</span> <span class="token operator">=</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$httpInfo</span><span class="token punctuation">,</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//入口</span>
<span class="token variable">$jscode</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'jscode'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'jscode'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$jscode</span> <span class="token operator">!=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$getOpenid</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">getOpenid</span><span class="token punctuation">(</span><span class="token variable">$jscode</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$getOpenid</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getCurl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
</body>

</html>
