<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Node.js学习 （二）搭建http服务器</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
<h2 style="text-align: center">Node.js学习 （二）搭建http服务器</h2>
  <div class="stackedit__html"><blockquote>
<p>http 这个模块的职责就是帮你创建编写服务器的<br>
在 Node 中专门提供了一个核心模块：http</p>
</blockquote>
<h5><a id="1__http__4"></a>1. 加载 http 核心模块</h5>
<pre><code class="prism language-javascript"><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
</code></pre>
<h5><a id="2__httpcreateServer__Web__8"></a>2. 使用 http.createServer() 方法创建一个 Web 服务器</h5>
<pre><code class="prism language-javascript"><span class="token comment">//    返回一个 Server 实例</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h5><a id="3__13"></a>3. 收发数据</h5>
<ol>
<li>注册监听 request 请求事件</li>
</ol>
<pre><code class="prism language-javascript"><span class="token comment">//    发请求 、接收请求 、处理请求、 给个反馈（发送响应）   </span>
<span class="token comment">//    当客户端请求过来，就会自动触发服务器的 request 请求事件，然后执行第二个参数：回调处理函数</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'收到客户端的请求了'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>request 请求事件处理函数</li>
</ol>
<blockquote>
<p><code>Request</code> 请求对象:<br>
请求对象可以用来获取客户端的一些请求信息，例如请求路径<br>
<code>Response</code> 响应对象:<br>
响应对象可以用来给客户端发送响应消息</p>
</blockquote>
<pre><code class="prism language-javascript">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// http://127.0.0.1:3000/ 请求路径就是 ： /</span>
  <span class="token comment">// http://127.0.0.1:3000/a 请求路径就是 ：/a</span>
  <span class="token comment">// http://127.0.0.1:3000/foo/b 请求路径就是  /foo/b</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'收到客户端的请求了，请求路径是：'</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
  
  <span class="token comment">// response 对象有一个方法：write 可以用来给客户端发送响应数据</span>
  <span class="token comment">// write 可以使用多次，但是最后一定要使用 end 来结束响应，否则客户端会一直等待</span>
  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">' nodejs'</span><span class="token punctuation">)</span>

  <span class="token comment">// 告诉客户端，我的话说完了，你可以呈递给用户了</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<ol start="3">
<li>请求路径区分</li>
</ol>
<pre><code class="prism language-javascript">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'收到请求了，请求路径是：'</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
	 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求我的客户端的地址是：'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>remoteAddress<span class="token punctuation">,</span> req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>remotePort<span class="token punctuation">)</span>
	 <span class="token comment">// res.write('hello')</span>
	 <span class="token comment">// res.write(' world')</span>
	 <span class="token comment">// res.end()</span>
	 
	 <span class="token comment">// 上面的方式比较麻烦，推荐使用更简单的方式，直接 end 的同时发送响应数据</span>
	 <span class="token comment">// res.end('hello nodejs')</span>
	 
	 <span class="token comment">// 1. 获取请求路径, req.url 获取到的是端口号之后的那一部分路径。</span>
	 <span class="token comment">//也就是说所有的 url 都是以 / 开头的</span>
	 <span class="token comment">// 2. 判断路径处理响应</span>
	 <span class="token keyword">var</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
	
	 <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	   res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'index page'</span><span class="token punctuation">)</span>
	 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	   res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'login page'</span><span class="token punctuation">)</span>
	 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/products'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	   <span class="token keyword">var</span> products <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
	       name<span class="token punctuation">:</span> <span class="token string">'苹果 X'</span><span class="token punctuation">,</span>
	       price<span class="token punctuation">:</span> <span class="token number">8888</span>
	     <span class="token punctuation">}</span><span class="token punctuation">,</span>
	     <span class="token punctuation">{</span>
	       name<span class="token punctuation">:</span> <span class="token string">'菠萝 X'</span><span class="token punctuation">,</span>
	       price<span class="token punctuation">:</span> <span class="token number">5000</span>
	     <span class="token punctuation">}</span><span class="token punctuation">,</span>
	     <span class="token punctuation">{</span>
	       name<span class="token punctuation">:</span> <span class="token string">'小辣椒 X'</span><span class="token punctuation">,</span>
	       price<span class="token punctuation">:</span> <span class="token number">1999</span>
	     <span class="token punctuation">}</span>
	   <span class="token punctuation">]</span>
	   <span class="token comment">// 响应内容只能是二进制数据或者字符串  、数字、 对象、 数组、 布尔值</span>
	   res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>products<span class="token punctuation">)</span><span class="token punctuation">)</span>
	 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	   res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'404 Not Found.'</span><span class="token punctuation">)</span>
	 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<ol start="4">
<li>编码</li>
</ol>
<blockquote>
<p>在服务端默认发送的数据，其实是 utf8 编码的内容 , 但是浏览器不知道你是 utf8 编码的内容<br>
浏览器在不知道服务器响应内容的编码的情况下会按照当前操作系统的默认编码去解析<br>
中文操作系统默认是 gbk</p>
</blockquote>
<blockquote>
<p>在 http 协议中，Content-Type 就是用来告知对方我给你发送的数据内容是什么类型</p>
</blockquote>
<blockquote>
<p><code>res.setHeader('Content-Type', 'text/plain; charset=utf-8')</code></p>
</blockquote>
<pre><code class="prism language-javascript">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url

  <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/plain'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// text/plain 就是普通文本, charset=utf-8 设置utf-8编码</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello 世界'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/html'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果你发送的是 html 格式的字符串，则也要告诉浏览器我给你发送是 text/html 格式的内容</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;hello html &lt;a href=""&gt;点我&lt;/a&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h5><a id="4__111"></a>4. 绑定端口号，启动服务器</h5>
<pre><code class="prism language-javascript">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功了，可以通过 http://127.0.0.1:3000/ 来进行访问'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre>
<h5><a id="5__118"></a>5. 简写方式</h5>
<pre><code class="prism language-javascript"><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 简写方式，该函数会直接被注册为 server 的 request 请求事件处理函数</span>
http
	<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//数据注册直接在函数内完成了</span>
		<span class="token comment">//req就是请求数据,res就是需要返回的数据对象</span>
		
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功了，可以通过 http://127.0.0.1:3000/ 来进行访问'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre>
</div>
</body>

</html>
